
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>6.2.3. Multiprocessing with PYSPEX &#8212; SPEX Help Center 3.08.01 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="canonical" href="https://spex-xray.github.io/spex-help/pyspex/multip.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6.3.1. Session class structure" href="session.html" />
    <link rel="prev" title="6.2.2. Astropy units and tables" href="astropy.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="multiprocessing-with-pyspex">
<span id="pyspex-multip"></span><h1><span class="section-number">6.2.3. </span>Multiprocessing with PYSPEX<a class="headerlink" href="#multiprocessing-with-pyspex" title="Permalink to this heading">¶</a></h1>
<p>As described in <a class="reference internal" href="session.html#pyspex-session"><span class="std std-ref">Session class structure</span></a>, a PYSPEX session can only be started once, at least per process or thread. This
can be an annoying limitation if you want to run several SPEX sessions at once. This problem can be partly circumvented
by using the <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> module of Python. This module is able to run functions in parallel with different
input parameters.</p>
<p>So, if you have a problem that requires you to run SPEX multiple times with a very similar setup, but different input
parameters, then this thread may be helpful to you.</p>
<p>The following script calculates the spectrum emitted by a CIE plasma for four different temperatures. This is
just a simple example. This particular problem can be calculated more efficiently in a different way, but this shows
the potential of the <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> module if you need to do more complicated calculations.</p>
<p>First, we show the full script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">pyspex.spex</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="c1"># Define the function that calls pyspex</span>
<span class="c1"># and does the calculation and/or</span>
<span class="c1"># analysis that you want</span>

<span class="k">def</span> <span class="nf">ciecalc</span><span class="p">(</span><span class="n">kt</span><span class="p">):</span>
    <span class="c1"># Start the SPEX session</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

    <span class="c1"># Load a CIE model and choose</span>
    <span class="c1"># the SPEXACT version 3 database</span>
    <span class="n">s</span><span class="o">.</span><span class="n">com</span><span class="p">(</span><span class="s1">&#39;cie&#39;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">var_calc</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Set the temperature of the plasma</span>
    <span class="n">s</span><span class="o">.</span><span class="n">par</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="n">kt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Calculate the model</span>
    <span class="n">s</span><span class="o">.</span><span class="n">calc</span><span class="p">()</span>

    <span class="c1"># Save the output spectral model</span>
    <span class="c1"># to a FITS file</span>
    <span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">plt</span><span class="p">)</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">plot_model</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">sector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tabmodel</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cie_</span><span class="si">{0}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Close this SPEX session gently</span>
    <span class="n">s</span><span class="o">.</span><span class="fm">__del__</span><span class="p">()</span>


<span class="c1"># The function below is executed when this</span>
<span class="c1"># script is executed from the terminal:</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># Maximum number of processes to</span>
    <span class="c1"># create at once</span>
    <span class="n">nproc</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># The temperatures for which to</span>
    <span class="c1"># calculate the CIE spectrum</span>
    <span class="n">kt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">)</span>

    <span class="c1"># Pack the input parameters into one</span>
    <span class="c1"># iterable variable</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kt</span><span class="p">)</span>

    <span class="c1"># Create a new pool of processes (nproc)</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Call the ciecalc function with each argument</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">ciecalc</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

    <span class="c1"># Close the pool</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<p>Next, we will discuss the details of each part of this script.</p>
<section id="needed-python-modules">
<h2><span class="section-number">6.2.3.1. </span>Needed Python modules<a class="headerlink" href="#needed-python-modules" title="Permalink to this heading">¶</a></h2>
<p>For this script, PYSPEX is obviously needed and is imported as usual. The other module is <code class="docutils literal notranslate"><span class="pre">multiprocessing.Pool</span></code>,
which will handle the multiprocessing for us (see also <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html">Python multiprocessing</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">pyspex.spex</span> <span class="kn">import</span> <span class="n">Session</span>
</pre></div>
</div>
</section>
<section id="the-ciecalc-function">
<h2><span class="section-number">6.2.3.2. </span>The ciecalc function<a class="headerlink" href="#the-ciecalc-function" title="Permalink to this heading">¶</a></h2>
<p>The function <code class="docutils literal notranslate"><span class="pre">ciecalc</span></code> is our worker function here. This means that this function will start a PYSPEX session,
executes a number of SPEX commands (based on the input arguments), and produces a result. In this case, we
add one CIE component, set a temperature read from the function input arguments, and calculate the spectrum.
In the last step, we get the calculated spectrum from a model plot and save it to FITS format. The temperature
value is included in the output filename.</p>
<p>It is important here to have the start of the PYSPEX session <code class="docutils literal notranslate"><span class="pre">s=Session()</span></code> inside the function. Remember that
you can only have one Session per process, so this needs to be defined in each process separately to make PYSPEX
run in parallel.</p>
<p>In this example, we just vary the temperature in each calculation, but this can be expanded to more variables
or options. There are multiple ways of approaching this:</p>
<ol class="arabic simple">
<li><p>You create a worker function with multiple arguments (see <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool.starmap">starmap</a>).</p></li>
<li><p>You pack the variables in an object such that you can pass that object to the function. This object could be
a Python list or dictionary, or a custom object that you define. The function should be able to read the
variables and instructions from the input object.</p></li>
<li><p>You pass a filename of a SPEX <code class="docutils literal notranslate"><span class="pre">.com</span></code> file or other configuration file at each iteration.</p></li>
</ol>
<p>Make sure to call the <code class="docutils literal notranslate"><span class="pre">s.__del__()</span></code> at the very end of your function to close SPEX gently at the end. This
will delete all the <code class="docutils literal notranslate"><span class="pre">*.dum</span></code> files as well.</p>
</section>
<section id="set-up-multiprocessing">
<h2><span class="section-number">6.2.3.3. </span>Set up multiprocessing<a class="headerlink" href="#set-up-multiprocessing" title="Permalink to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">nproc</span></code> variable specifies the number of processes to run at the same time. Choose this parameter wisely
based on the number of processors and amount of RAM memory in your computer. Also keep in mind that one PYSPEX
session may also use multiple processors at the same time.</p>
<blockquote>
<div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Please take care that you do not set <code class="docutils literal notranslate"><span class="pre">nproc</span></code> too high. A PYSPEX run can use between 1 and 4 GB
of RAM memory. If you do not have a lot of RAM, then these processes can make your system extremely
slow or even crash.</p>
</div>
</div></blockquote>
<p>It may be helpful to limit the number of cores used for each process. This can be done by setting the environment
variable <cite>OMP_NUM_THREADS</cite>. For example, if you have a computer with 16 cores and 32 GB of RAM memory, the optimal
setting would be <code class="docutils literal notranslate"><span class="pre">nproc=4</span></code> and <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">OMP_NUM_THREADS=4</span></code>. Or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;4&quot;</span>
</pre></div>
</div>
<p>Having 4 processes which can use 4 cores each gives you 16 cores at maximum, which is exactly the processor
specification. Assuming that each of the 4 processes uses 4 GB of memory at maximum, the total memory usage of 16GB
should fit easily on the available RAM memory chips.</p>
<p>The line that creates the pool of processes (<code class="docutils literal notranslate"><span class="pre">pool</span> <span class="pre">=</span> <span class="pre">Pool(processes=nproc,</span> <span class="pre">maxtasksperchild=1)</span></code>) needs a very
important option. The <code class="docutils literal notranslate"><span class="pre">maxtasksperchild=1</span></code> option tells the pool that each function needs to be performed in a
separate process. This ensures that the <code class="docutils literal notranslate"><span class="pre">s</span> <span class="pre">=</span> <span class="pre">Session()</span></code> command is only given once in each process.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">pool.map(ciecalc,</span> <span class="pre">arg)</span></code> line divides the tasks over the different processes and passes the arguments (<code class="docutils literal notranslate"><span class="pre">arg</span></code>)
to the <code class="docutils literal notranslate"><span class="pre">ciecalc</span></code> function. The <code class="docutils literal notranslate"><span class="pre">arg</span></code> variable needs to contain an iterable list or array. The <code class="docutils literal notranslate"><span class="pre">zip</span></code> function
can help to create a multi-dimensional array with input arguments if necessary. See also the <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool.starmap">starmap</a> function to pass multiple
arguments to the worker function.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">pool.close()</span></code> and <code class="docutils literal notranslate"><span class="pre">pool.join()</span></code> functions make sure that the processes are properly closed and that their
output is merged (if applicable).</p>
<p>The script above can be saved as <code class="docutils literal notranslate"><span class="pre">pyspexmp.py</span></code> and executed from the command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">pyspexmp</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>You should see multiple welcome messages from SPEX on your screen indicating that multiple instances of
SPEX are running.</p>
</section>
<section id="final-thoughts">
<h2><span class="section-number">6.2.3.4. </span>Final thoughts<a class="headerlink" href="#final-thoughts" title="Permalink to this heading">¶</a></h2>
<p>The method above is especially suitable for repeating long and more complicated PYSPEX sessions. Since the SPEX
is restarted each time a process starts, you will lose a couple of seconds. Therefore, this is only efficient if
the runtime of one iteration is much longer than a couple of seconds.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> module has many more options which may serve your needs. As long as you have only one SPEX
session per process, everything should run well.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo-wide.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getstarted.html">1. Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../threads.html">2. Analysis threads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">3. Command overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models.html">4. Spectral models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools.html">5. Additional tools</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../pyspex.html">6. Python Interface</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../pyspex.html#basic-commands">6.1. Basic commands</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../pyspex.html#analysis-threads-other-tricks">6.2. Analysis threads &amp; other tricks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pyspex.html#advanced-class-descriptions">6.3. Advanced class descriptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help.html">7. Help &amp; troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../theory.html">8. SPEX Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exercises.html">9. Exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">10. Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">11. Credits</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../pyspex.html"><span class="section-number">6. </span>Python Interface</a><ul>
      <li>Previous: <a href="astropy.html" title="previous chapter"><span class="section-number">6.2.2. </span>Astropy units and tables</a></li>
      <li>Next: <a href="session.html" title="next chapter"><span class="section-number">6.3.1. </span>Session class structure</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="footer">
        Last updated on: Sep 10, 2024.<br>
    
        &copy;2024, Jelle de Plaa, Jelle Kaastra, Liyi Gu, SPEX Development Team, <a href="https://www.sron.nl/">SRON Netherlands Institute for Space Research</a>.
    

</div>

  </body>
</html>